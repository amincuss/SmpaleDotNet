name: Build & Deploy .NET Core to IIS

on:
  push:
    branches:
      - master   # ÙÙ‚Ø· ÙˆÙ‚ØªÛŒ Ø¨Ø±Ù†Ú† main Ø¢Ù¾Ø¯ÛŒØª Ø´ÙˆØ¯ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯

jobs:
  deploy:
    runs-on: self-hosted   # runner Ø¨Ø§ÛŒØ¯ ÙˆÛŒÙ†Ø¯ÙˆØ²ÛŒ Ø¨Ø§Ø´Ø¯

    steps:
      # 1ï¸âƒ£ Ø¯Ø±ÛŒØ§ÙØª Ø³ÙˆØ±Ø³ Ø§Ø² GitHub
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Ú©Ù¾ÛŒ Ú©Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ù‡ Ù…Ø³ÛŒØ± Ù…Ø­Ù„ÛŒ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±
      - name: Copy repository to deploy directory
        shell: pwsh
        run: |
          $src = "${{ github.workspace }}"
          $dst = "C:\deploy\myapp"
          Write-Host "ğŸ“¦ Copying source code from $src to $dst ..."
          if (Test-Path $dst) {
              Remove-Item $dst -Recurse -Force
          }
          Copy-Item -Path "$src" -Destination $dst -Recurse -Force
          Write-Host "âœ… Source copied successfully."

      # 3ï¸âƒ£ Ù†ØµØ¨ SDK
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'   # Ù†Ø³Ø®Ù‡ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø®ÙˆØ¯Øª

      # 4ï¸âƒ£ Restore Ù¾Ú©ÛŒØ¬â€ŒÙ‡Ø§
      - name: Restore NuGet packages
        shell: pwsh
        run: |
          cd "C:\deploy\myapp"
          Write-Host "ğŸ”„ Restoring NuGet packages..."
          dotnet restore
          if ($LASTEXITCODE -ne 0) { throw "âŒ Restore failed." }

      # 5ï¸âƒ£ Build Ù¾Ø±ÙˆÚ˜Ù‡
      - name: Build project
        shell: pwsh
        run: |
          cd "C:\deploy\myapp"
          Write-Host "âš™ï¸ Building project..."
          dotnet build --configuration Release
          if ($LASTEXITCODE -ne 0) { throw "âŒ Build failed." }

      # 6ï¸âƒ£ Publish Ø®Ø±ÙˆØ¬ÛŒ Ù†Ù‡Ø§ÛŒÛŒ
      - name: Publish project
        shell: pwsh
        run: |
          cd "C:\deploy\myapp"
          Write-Host "ğŸš€ Publishing project..."
          dotnet publish --configuration Release --output "C:\deploy\myapp\publish"
          if ($LASTEXITCODE -ne 0) { throw "âŒ Publish failed." }

      # 7ï¸âƒ£ Ú©Ù¾ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ù…Ø³ÛŒØ± IIS
      - name: Deploy to IIS site
        shell: pwsh
        run: |
          $publishPath = "C:\deploy\myapp\publish"
          $iisPath = "C:\inetpub\wwwroot"
          Write-Host "ğŸ“‚ Copying published files to IIS directory..."
          if (Test-Path $publishPath -and Test-Path $iisPath) {
              Copy-Item -Path "$publishPath\*" -Destination $iisPath -Recurse -Force
              Write-Host "âœ… Files copied successfully to IIS."
          } else {
              Write-Error "âŒ Publish or IIS path not found."
              exit 1
          }

      # 8ï¸âƒ£ Ø±ÛŒØ³ØªØ§Ø±Øª IIS
      - name: Restart IIS
        shell: pwsh
        run: |
          Write-Host "ğŸ” Restarting IIS service..."
          iisreset
          if ($LASTEXITCODE -ne 0) { throw "âŒ IIS restart failed." }
          Write-Host "âœ… IIS restarted successfully."
