name: Build & Deploy .NET Core to IIS

on:
  push:
    branches:
      - master   # Ø§Ø¬Ø±Ø§ ÙÙ‚Ø· Ù‡Ù†Ú¯Ø§Ù… push Ø±ÙˆÛŒ Ø¨Ø±Ù†Ú† main

jobs:
  deploy:
    runs-on: self-hosted  # Ø¨Ø§ÛŒØ¯ runner ÙˆÛŒÙ†Ø¯ÙˆØ²ÛŒ Ø´Ø®ØµÛŒ Ø¨Ø§Ø´Ø¯
    steps:
      # 1ï¸âƒ£ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø³ÙˆØ±Ø³ Ø§Ø² GitHub
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ØªØ§ Ú©Ù„ ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒÛŒ git Ú¯Ø±ÙØªÙ‡ Ø´ÙˆØ¯ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)

      # 2ï¸âƒ£ Ú©Ù¾ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ù‡ Ù…Ø³ÛŒØ± Ù…Ø´Ø®Øµ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±
      - name: Copy repository to deploy directory
        shell: pwsh
        run: |
          $src = "${{ github.workspace }}"
          $dst = "C:\deploy\myapp"
          Write-Host "ğŸ“¦ Copying source code from $src to $dst ..."
          if (Test-Path $dst) {
              Remove-Item $dst -Recurse -Force
          }
          Copy-Item -Path "$src" -Destination $dst -Recurse -Force
          Write-Host "âœ… Source copied successfully."

      # 3ï¸âƒ£ Ù†ØµØ¨ SDK Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'  # Ù†Ø³Ø®Ù‡â€ŒÛŒ Ù…Ù†Ø§Ø³Ø¨ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§Øª

      # 4ï¸âƒ£ Ù…Ø±Ø­Ù„Ù‡â€ŒÛŒ Restore
      - name: Restore NuGet packages
        shell: pwsh
        run: dotnet restore "C:\deploy\myapp\MyApp.csproj"

      # 5ï¸âƒ£ Build Ù¾Ø±ÙˆÚ˜Ù‡
      - name: Build project
        shell: pwsh
        run: dotnet build "C:\deploy\myapp\MyApp.csproj" --configuration Release

      # 6ï¸âƒ£ Publish Ù¾Ø±ÙˆÚ˜Ù‡
      - name: Publish project
        shell: pwsh
        run: dotnet publish "C:\deploy\myapp\MyApp.csproj" --configuration Release --output "C:\deploy\myapp\publish"

      # 7ï¸âƒ£ Ú©Ù¾ÛŒ Ø®Ø±ÙˆØ¬ÛŒ Ø¯Ø± Ù…Ø³ÛŒØ± IIS
      - name: Deploy to IIS path
        shell: pwsh
        run: |
          $publishPath = "C:\deploy\myapp\publish"
          $targetPath  = "C:\inetpub\wwwroot"
          Write-Host "ğŸš€ Deploying published files to $targetPath ..."
          if (Test-Path $targetPath) {
              Copy-Item -Path "$publishPath\*" -Destination $targetPath -Recurse -Force
              Write-Host "âœ… Deployment completed successfully."
          } else {
              Write-Error "âŒ Target path not found: $targetPath"
          }

      # 8ï¸âƒ£ Ø±ÛŒØ³ØªØ§Ø±Øª IIS (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
      - name: Restart IIS Service
        shell: pwsh
        run: iisreset
